import React, { useEffect, useState } from "react";
import {
    View,
    Text,
    TouchableOpacity,
    ActivityIndicator,
    Image,
    ScrollView,
    Alert,
    Dimensions,
    Platform,
} from "react-native";
import {
    collection,
    query,
    orderBy,
    limit,
    onSnapshot,
    addDoc,
    serverTimestamp,
    getDocs,
    deleteDoc
} from "firebase/firestore";
import {ref, uploadBytes, getDownloadURL, deleteObject} from "firebase/storage";
import { db, storage } from "@/firebase/config";
import { Ionicons } from "@expo/vector-icons";
import * as ImagePicker from "expo-image-picker";
import * as DocumentPicker from "expo-document-picker";
import {useSafeAreaFrame, useSafeAreaInsets} from "react-native-safe-area-context";
import DateTimePicker from "@react-native-community/datetimepicker";
import { router } from "expo-router";
import * as FileSystem from "expo-file-system";
import * as Sharing from "expo-sharing";
import * as Linking from "expo-linking";
import * as MediaLibrary from "expo-media-library";

export default function BulletinPage() {
    const insets = useSafeAreaInsets();
    const [loading, setLoading] = useState(true);
    const [selectedBulletin, setSelectedBulletin] = useState<any>(null);
    const [mode, setMode] = useState<"view" | "upload">("view");
    const [title, setTitle] = useState("");
    const [selectedDate, setSelectedDate] = useState<Date>(new Date());
    const [showDatePicker, setShowDatePicker] = useState(false);
    const [imageFiles, setImageFiles] = useState<any[]>([]);
    const [pdfFile, setPdfFile] = useState<any>(null);
    const [uploading, setUploading] = useState(false);

    const frame = useSafeAreaFrame();

    // üö® Í¥ÄÎ¶¨Ïûê Í∂åÌïú (ÏûÑÏãúÎ°ú true Ï≤òÎ¶¨, Ïã§Ï†úÎ°úÎäî Î°úÍ∑∏Ïù∏ Ïú†Ï†Ä role Ï≤¥ÌÅ¨)
    const isAdmin = true;

    useEffect(() => {
        const q = query(collection(db, "bulletins"), orderBy("createdAt", "desc"), limit(1));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                setSelectedBulletin({
                    id: doc.id,
                    ...doc.data(),
                });
            } else {
                setSelectedBulletin(null);
            }
            setLoading(false);
        });
        return unsubscribe;
    }, []);

    const pickImage = async () => {
        const { status } = await ImagePicker.requestMediaLibraryPermissionsAsync();
        if (status !== 'granted') {
            Alert.alert('Í∂åÌïú ÌïÑÏöî', 'Ïù¥ÎØ∏ÏßÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
            return;
        }

        const result = await ImagePicker.launchImageLibraryAsync({
            mediaTypes: ImagePicker.MediaTypeOptions.Images,
            allowsMultipleSelection: true,
            quality: 0.8,
        });

        if (!result.canceled && result.assets.length > 0) {
            setImageFiles(result.assets);
        }
    };

    const pickFile = async () => {
        try {
            const result = await DocumentPicker.getDocumentAsync({
                type: "application/pdf",
            });
            if (!result.canceled && result.assets?.length > 0) {
                setPdfFile(result.assets[0]);
            }
        } catch (err) {
            console.error("PDF ÏÑ†ÌÉù Ïò§Î•ò:", err);
        }
    };

    const uploadBulletin = async () => {
        if ((imageFiles.length === 0 && !pdfFile)) {
            Alert.alert("ÌïÑÏàò Ìï≠Î™© ÎàÑÎùΩ", "Ï†úÎ™©Í≥º ÌååÏùº(Ïù¥ÎØ∏ÏßÄ ÎòêÎäî PDF)ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.");
            return;
        }

        setUploading(true);
        const uploadedImageUrls: string[] = [];

        try {
            // üóë Í∏∞Ï°¥ Ï£ºÎ≥¥ ÏÇ≠Ï†ú
            const q = query(collection(db, "bulletins"), orderBy("createdAt", "desc"), limit(1));
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                const docToDelete = snapshot.docs[0];
                const data = docToDelete.data();

                // üî• Í∏∞Ï°¥ Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú
                if (data.images && Array.isArray(data.images)) {
                    for (const url of data.images) {
                        const filePath = decodeURIComponent(url.split('/o/')[1].split('?')[0]); // ÌååÏùº Í≤ΩÎ°ú Ï∂îÏ∂ú
                        const fileRef = ref(storage, filePath);
                        await deleteObject(fileRef).catch(err => console.log("Ïù¥ÎØ∏ÏßÄ ÏÇ≠Ï†ú Ïò§Î•ò:", err));
                    }
                }

                // üî• Í∏∞Ï°¥ PDF ÏÇ≠Ï†ú
                if (data.pdf) {
                    const pdfPath = decodeURIComponent(data.pdf.split('/o/')[1].split('?')[0]);
                    const pdfRef = ref(storage, pdfPath);
                    await deleteObject(pdfRef).catch(err => console.log("PDF ÏÇ≠Ï†ú Ïò§Î•ò:", err));
                }

                // üî• Firestore Î¨∏ÏÑú ÏÇ≠Ï†ú
                await deleteDoc(docToDelete.ref);
                console.log("‚úÖ Í∏∞Ï°¥ Ï£ºÎ≥¥ ÏÇ≠Ï†ú ÏôÑÎ£å");
            }

            // ‚úÖ Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú
            for (const image of imageFiles) {
                const response = await fetch(image.uri);
                const blob = await response.blob();
                const fileRef = ref(storage, `bulletins/images/${Date.now()}-${image.fileName || "image"}`);
                await uploadBytes(fileRef, blob);
                const downloadUrl = await getDownloadURL(fileRef);
                uploadedImageUrls.push(downloadUrl);
            }

            // ‚úÖ PDF ÏóÖÎ°úÎìú
            let pdfUrl = null;
            if (pdfFile) {
                const response = await fetch(pdfFile.uri);
                const blob = await response.blob();
                const fileRef = ref(storage, `bulletins/pdfs/${Date.now()}-${pdfFile.name}`);
                await uploadBytes(fileRef, blob);
                pdfUrl = await getDownloadURL(fileRef);
            }

            // ‚úÖ Firestore Ï†ÄÏû•
            await addDoc(collection(db, "bulletins"), {
                title,
                date: selectedDate.toISOString().split("T")[0],
                images: uploadedImageUrls,
                pdf: pdfUrl,
                createdAt: serverTimestamp(),
            });

            Alert.alert("ÏóÖÎ°úÎìú ÏôÑÎ£å", "Ï£ºÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.");
            setMode("view");
            setTitle("");
            setImageFiles([]);
            setPdfFile(null);
        } catch (err) {
            console.error("‚ùå ÏóÖÎ°úÎìú Ï§ë Ïò§Î•ò:", err);
            Alert.alert("ÏóÖÎ°úÎìú Ïã§Ìå®", "Ï£ºÎ≥¥ ÏóÖÎ°úÎìú Ï§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        } finally {
            setUploading(false);
        }
    };

    const saveImageToGallery = async (url: string, filename: string) => {
        try {
            // üì∏ ÎØ∏ÎîîÏñ¥ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í∂åÌïú ÏöîÏ≤≠
            const { status } = await MediaLibrary.requestPermissionsAsync();
            if (status !== 'granted') {
                Alert.alert("Í∂åÌïú ÌïÑÏöî", "ÏÇ¨ÏßÑÏùÑ Ï†ÄÏû•ÌïòÎ†§Î©¥ Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                return;
            }

            // üì• Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú
            const fileUri = FileSystem.documentDirectory + filename;
            const downloadResult = await FileSystem.downloadAsync(url, fileUri);
            console.log("‚úÖ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å:", downloadResult.uri);

            // üìÇ Ïï®Î≤îÏóê Ï†ÄÏû•
            const asset = await MediaLibrary.createAssetAsync(downloadResult.uri);
            await MediaLibrary.createAlbumAsync("Bulletins", asset, false);

            Alert.alert("Ï†ÄÏû• ÏÑ±Í≥µ", "Ïù¥ÎØ∏ÏßÄÍ∞Ä Ïï®Î≤îÏóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
        } catch (err) {
            console.error("‚ùå Ï†ÄÏû• Ïã§Ìå®:", err);
            Alert.alert("Ï†ÄÏû• Ïò§Î•ò", "Ïù¥ÎØ∏ÏßÄÎ•º Ïï®Î≤îÏóê Ï†ÄÏû•Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
        }
    };


    const handleDownloadAndShare = async (url: string, filename: string) => {
        try {
            // 1. ÌååÏùº Îã§Ïö¥Î°úÎìú
            const fileUri = FileSystem.documentDirectory + filename;
            const downloaded = await FileSystem.downloadAsync(url, fileUri);

            console.log("üì• ÌååÏùº Îã§Ïö¥Î°úÎìú ÏôÑÎ£å:", downloaded.uri);

            // 2. Í≥µÏú† ÏãúÌä∏ Ïó¥Í∏∞
            if (await Sharing.isAvailableAsync()) {
                await Sharing.shareAsync(downloaded.uri);
            } else {
                Alert.alert("Í≥µÏú† Î∂àÍ∞Ä", "Ïù¥ ÎîîÎ∞îÏù¥Ïä§ÏóêÏÑú Í≥µÏú† Í∏∞Îä•ÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
            }
        } catch (err) {
            console.error("‚ùå ÌååÏùº Îã§Ïö¥Î°úÎìú/Í≥µÏú† Ïã§Ìå®:", err);
            Alert.alert("Ïò§Î•ò", "ÌååÏùºÏùÑ Îã§Ïö¥Î°úÎìúÌïòÍ±∞ÎÇò Í≥µÏú†ÌïòÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
        }
    };

    const renderViewMode = () => (
        <View style={{ flex: 1, backgroundColor: "#fff", paddingTop: insets.top }}>
            {/* üî• ÏÉÅÎã® Ìó§Îçî */}
            <View
                style={{
                    flexDirection: "row",
                    alignItems: "center",
                    justifyContent: "space-between", // Ï¢åÏö∞ Í∑†Ìòï
                    paddingVertical: 12,
                    paddingHorizontal: 16,
                    borderBottomWidth: 1,
                    borderColor: "#eee",
                }}
            >
                {/* üîô Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº */}
                <TouchableOpacity onPress={() => router.back()}>
                    <Ionicons name="arrow-back" size={24} color="#007AFF" />
                </TouchableOpacity>

                {/* üìÖ ÎÇ†Ïßú */}
                {selectedBulletin ? (
                    <Text
                        style={{
                            fontSize: 24,
                            fontWeight: "600",
                            color: "#333",
                        }}
                    >
                        {selectedBulletin.date} Ï£ºÎ≥¥
                    </Text>
                ) : (
                    <ActivityIndicator size="small" color="#888" />
                )}

                {/* üî• Ïò§Î•∏Ï™ΩÏóê Í≥µÍ∞Ñ ÌôïÎ≥¥Ïö© Î∑∞ */}
                <View style={{ width: 24 }} />
            </View>

            {loading ? (
                <ActivityIndicator size="large" color="#007AFF" style={{ marginTop: 50 }} />
            ) : selectedBulletin ? (
                <ScrollView contentContainerStyle={{ padding: 16 }}>

                    {/* üñº Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ */}
                    {selectedBulletin.images && selectedBulletin.images.length > 0 && (
                        <ScrollView horizontal showsHorizontalScrollIndicator={false} style={{ marginBottom: 20 }}>
                            {selectedBulletin.images.map((imgUrl: string, idx: number) => (
                                <View key={idx} style={{ marginRight: 16 }}>
                                    <Image
                                        source={{ uri: imgUrl }}
                                        style={{
                                            width: frame.width* 0.8,
                                            height: frame.height * 0.6,
                                            borderRadius: 8,
                                        }}
                                    />
                                    <TouchableOpacity
                                        onPress={() => saveImageToGallery(imgUrl, `bulletin_${idx + 1}.jpg`)}
                                        style={{
                                            backgroundColor: "#28a745",
                                            padding: 10,
                                            borderRadius: 8,
                                            alignItems: "center",
                                            marginTop: 10,
                                        }}
                                    >
                                        <Text style={{ color: "#fff", fontSize: 16 }}>üì• Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•</Text>
                                    </TouchableOpacity>
                                </View>
                            ))}
                        </ScrollView>
                    )}

                    {/* üìÑ PDF Îã§Ïö¥Î°úÎìú */}
                    <TouchableOpacity
                        onPress={() => handleDownloadAndShare(selectedBulletin.pdf, "bulletin.pdf")}
                        style={{
                            backgroundColor: "#007AFF",
                            padding: 12,
                            borderRadius: 8,
                            alignItems: "center",
                            marginVertical: 10,
                        }}
                    >
                        <Text style={{ color: "#fff", fontSize: 16 }}>üì• PDF Îã§Ïö¥Î°úÎìú Î∞è Í≥µÏú†</Text>
                    </TouchableOpacity>
                </ScrollView>
            ) : (
                <Text style={{ textAlign: "center", marginTop: 50, color: "#999" }}>
                    Îì±Î°ùÎêú Ï£ºÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.
                </Text>
            )}

            {/* ‚úÖ Í¥ÄÎ¶¨Ïûê ÏóÖÎ°úÎìú Î≤ÑÌäº */}
            {isAdmin && (
                <TouchableOpacity
                    onPress={() => setMode("upload")}
                    style={{
                        position: "absolute",
                        bottom: 30,
                        right: 30,
                        backgroundColor: "#007AFF",
                        borderRadius: 30,
                        padding: 16,
                        elevation: 4,
                    }}
                >
                    <Ionicons name="cloud-upload-outline" size={24} color="#fff" />
                </TouchableOpacity>
            )}
        </View>
    );

    const renderUploadMode = () => (
        <View style={{ flex: 1, backgroundColor: "#fff", paddingTop: insets.top + 10 }}>
            <TouchableOpacity onPress={() => setMode("view")} style={{ margin: 10 }}>
                <Ionicons name="arrow-back" size={24} color="#007AFF" />
            </TouchableOpacity>
            <ScrollView contentContainerStyle={{ padding: 16 }}>
                <Text style={{ fontSize: 20, fontWeight: "bold", marginBottom: 20 }}>üì§ Ï£ºÎ≥¥ ÏóÖÎ°úÎìú</Text>

                <TouchableOpacity onPress={() => setShowDatePicker(true)} style={{ marginBottom: 20 }}>
                    <Text style={{ fontSize: 16, borderBottomWidth: 1, paddingBottom: 8 }}>
                        üìÖ {selectedDate.toISOString().split("T")[0]}
                    </Text>
                </TouchableOpacity>
                {showDatePicker && (
                    <DateTimePicker
                        value={selectedDate}
                        mode="date"
                        display={Platform.OS === "ios" ? "inline" : "default"}
                        onChange={(event, date) => {
                            setShowDatePicker(false);
                            if (date) setSelectedDate(date);
                        }}
                    />
                )}

                <TouchableOpacity onPress={pickImage} style={{ marginBottom: 10 }}>
                    <Text style={{ color: "#007AFF", fontSize: 16 }}>üñº Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù</Text>
                </TouchableOpacity>
                <TouchableOpacity onPress={pickFile} style={{ marginBottom: 20 }}>
                    <Text style={{ color: "#007AFF", fontSize: 16 }}>üìÑ PDF ÏÑ†ÌÉù</Text>
                </TouchableOpacity>

                {/* Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ */}
                {imageFiles.length > 0 && (
                    <ScrollView horizontal style={{ marginBottom: 10 }}>
                        {imageFiles.map((img, idx) => (
                            <Image
                                key={idx}
                                source={{ uri: img.uri }}
                                style={{ width: 100, height: 100, marginRight: 8, borderRadius: 8 }}
                            />
                        ))}
                    </ScrollView>
                )}

                {/* PDF ÎØ∏Î¶¨Î≥¥Í∏∞ */}
                {pdfFile && (
                    <View style={{
                        flexDirection: 'row',
                        alignItems: 'center',
                        marginBottom: 10,
                        backgroundColor: "#f0f0f0",
                        borderRadius: 8,
                        padding: 10,
                    }}>
                        <Ionicons name="document-text-outline" size={40} color="#888" style={{ marginRight: 10 }} />
                        <Text numberOfLines={1} style={{ flex: 1 }}>{pdfFile.name}</Text>
                    </View>
                )}

                {/* ÏóÖÎ°úÎìú Î≤ÑÌäº */}
                {uploading ? (
                    <ActivityIndicator size="large" color="#007AFF" />
                ) : (
                    <TouchableOpacity
                        onPress={uploadBulletin}
                        style={{
                            backgroundColor: "#007AFF",
                            padding: 15,
                            borderRadius: 8,
                            alignItems: "center",
                        }}
                    >
                        <Text style={{ color: "#fff", fontSize: 16 }}>ÏóÖÎ°úÎìú</Text>
                    </TouchableOpacity>
                )}
            </ScrollView>
        </View>
    );

    console.log(selectedBulletin)

    return mode === "upload" ? renderUploadMode() : renderViewMode();
}

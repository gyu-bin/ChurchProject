import React, {useEffect, useRef, useState} from 'react';
import {
    View, Text, TouchableOpacity, SafeAreaView, Platform, ScrollView, KeyboardAvoidingView, Alert, Modal, FlatList,
    LayoutAnimation, UIManager, TextInput
} from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useRouter } from 'expo-router';
import { useAppTheme } from '@/context/ThemeContext';
import { useDesign } from '@/context/DesignSystem';
import ThemeToggle from "@/components/ThemeToggle";
import PushSettings from "@/components/VerseNotificationSettings";
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import {doc, updateDoc, onSnapshot, deleteDoc} from 'firebase/firestore';
import { db } from '@/firebase/config';
import { removeDeviceToken } from "@/services/registerPushToken";
import { logoutUser } from "@/redux/slices/userSlice";
import { clearPrayers } from "@/redux/slices/prayerSlice";
import { clearTeams } from "@/redux/slices/teamSlice";
import { useAppDispatch } from '@/hooks/useRedux';
import Toast from 'react-native-root-toast';
import { setScrollCallback } from "@/utils/scrollRefManager";
import DeviceManager from '@/components/DeviceManager';
import {getAuth} from "firebase/auth";
import {signInWithEmailAndPassword, updatePassword} from "@react-native-firebase/auth";
import {changePassword, reauthenticate} from "@/services/authService";
import NotificationModal from "@/components/NotificationModal";

if (Platform.OS === 'android' && UIManager.setLayoutAnimationEnabledExperimental) {
    UIManager.setLayoutAnimationEnabledExperimental(true);
}

export default function SettingsScreen() {
    const [user, setUser] = useState<any>(null);
    const router = useRouter();
    const { mode } = useAppTheme();
    const isDark = mode === 'dark';
    const { colors, spacing, font, radius } = useDesign();
    const insets = useSafeAreaInsets();
    const horizontalMargin = Platform.OS === 'ios' ? 20 : 16;

    const [showUpgradeModal, setShowUpgradeModal] = useState(false);
    const scrollRef = useRef<ScrollView>(null);
    const dispatch = useAppDispatch();

    const [showDevices, setShowDevices] = useState(false);
    const [showEditProfile, setShowEditProfile] = useState(false);
    const [showDeleteAccount, setShowDeleteAccount] = useState(false);
    const [modalVisible, setModalVisible] = useState(false);
    const [editValues, setEditValues] = useState<Record<string, string>>({});

    const [passwordModalVisible, setPasswordModalVisible] = useState(false);
    const [oldPassword, setOldPassword] = useState('');
    const [newPassword, setNewPassword] = useState('');
    const [passwordStage, setPasswordStage] = useState<'verify' | 'new'>('verify');
    // const [notificationModalVisible, setNotificationModalVisible] = useState(false); // ‚úÖ ÏïåÎ¶º Î™®Îã¨ ÏÉÅÌÉú

    useEffect(() => {
        setScrollCallback('settings', () => {
            scrollRef.current?.scrollTo({ y: 0, animated: true });
        });
    }, []);

    useEffect(() => {
        let unsubscribe: () => void;

        const listenUser = async () => {
            const raw = await AsyncStorage.getItem('currentUser');
            if (!raw) return;
            const cachedUser = JSON.parse(raw);
            const userRef = doc(db, 'users', cachedUser.email);

            unsubscribe = onSnapshot(userRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const fresh = { ...docSnap.data(), email: cachedUser.email };
                    setUser(fresh); // ‚úÖ Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    await AsyncStorage.setItem('currentUser', JSON.stringify(fresh));
                }
            });
        };

        listenUser();

        return () => {
            if (unsubscribe) unsubscribe();
        };
    }, []);

    const handleEditToggle = () => {
        if (!showEditProfile && user) {
            setEditValues({
                name: user.name ?? '',
                email: user.email ?? '',
                division: user.division ?? '',
                campus: user.campus ?? '',
                role: user.role ?? '',
            });
        }
        setShowEditProfile(prev => !prev);
    };

    const handleUpgrade = async () => {
        if (!user?.email) return;

        const updatedUser = { ...user, role: 'Ï†ïÌöåÏõê' };
        await updateDoc(doc(db, 'users', user.email), { role: 'Ï†ïÌöåÏõê' });
        await AsyncStorage.setItem('currentUser', JSON.stringify(updatedUser));
        setUser(updatedUser);
        setShowUpgradeModal(false);
        Toast.show('‚úÖ Ï†ïÌöåÏõêÏúºÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§.', {
            duration: Toast.durations.SHORT,
            position: Toast.positions.BOTTOM,
        });
    };

    const handleLogout = async () => {
        await removeDeviceToken();
        await AsyncStorage.removeItem('currentUser');
        await AsyncStorage.removeItem('useBiometric');
        dispatch(logoutUser());
        dispatch(clearPrayers());
        dispatch(clearTeams());
        router.replace('/auth/login');
    };

    const handleSaveProfile = async () => {
        if (!user?.name) return; // Î¨∏ÏÑú IDÎ°ú nameÏùÑ ÏÇ¨Ïö© Ï§ë

        const updatedFields: Record<string, string> = {};
        Object.entries(editValues).forEach(([key, value]) => {
            if (value !== user[key]) {
                updatedFields[key] = value;
            }
        });

        if (Object.keys(updatedFields).length === 0) {
            Toast.show('Î≥ÄÍ≤ΩÎêú ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.', {
                duration: Toast.durations.SHORT,
                position: Toast.positions.BOTTOM,
            });
            return;
        }

        try {
            // üîß Î¨∏ÏÑú IDÎ°ú name ÏÇ¨Ïö©
            await updateDoc(doc(db, 'users', user.name), updatedFields);

            const updatedUser = { ...user, ...updatedFields };
            setUser(updatedUser);
            await AsyncStorage.setItem('currentUser', JSON.stringify(updatedUser));

            Toast.show('‚úÖ Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', {
                duration: Toast.durations.SHORT,
                position: Toast.positions.BOTTOM,
            });

            setShowEditProfile(false);
        } catch (err) {
            console.error(err);
            Alert.alert('ÏàòÏ†ï Ïã§Ìå®', 'Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
        }
    };

    const handleDeleteAccount = async () => {
        if (!user?.email) return;

        Alert.alert(
            'Í≥ÑÏ†ï ÌÉàÌá¥',
            'Ï†ïÎßêÎ°ú Í≥ÑÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†ú ÌõÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.',
            [
                { text: 'Ï∑®ÏÜå', style: 'cancel' },
                {
                    text: 'ÏÇ≠Ï†ú',
                    style: 'destructive',
                    onPress: async () => {
                        try {
                            await deleteDoc(doc(db, 'users', user.email)); // üî• Firestore ÏÇ≠Ï†ú
                            await AsyncStorage.removeItem('currentUser'); // Î°úÏª¨ ÏÇ≠Ï†ú

                            dispatch(logoutUser());
                            dispatch(clearPrayers());
                            dispatch(clearTeams());

                            Toast.show('üëã Í≥ÑÏ†ïÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', {
                                duration: Toast.durations.SHORT,
                                position: Toast.positions.BOTTOM,
                            });

                            router.replace('/auth/login');
                        } catch (err) {
                            Alert.alert('Ïò§Î•ò Î∞úÏÉù', 'Í≥ÑÏ†ï ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                        }
                    },
                },
            ]
        );
    };

    return (
        <SafeAreaView style={{ flex: 1, backgroundColor: colors.background, paddingTop: Platform.OS === 'android' ? insets.top + 10 : 0 }}>
            <KeyboardAvoidingView style={{ flex: 1 }} behavior={Platform.OS === 'ios' ? 'padding' : undefined}>
                <ScrollView
                    ref={scrollRef}
                    contentContainerStyle={{ paddingTop: spacing.lg, paddingBottom: 40, paddingHorizontal: horizontalMargin }} showsVerticalScrollIndicator={false}>

                    <Text style={{ fontSize: font.heading, fontWeight: 'bold', color: colors.text, marginBottom: spacing.lg }}>‚öôÔ∏è ÏÑ§Ï†ï</Text>

                    {user && (
                        <View style={{ backgroundColor: colors.surface, borderRadius: radius.lg, padding: spacing.lg, marginBottom: spacing.lg, shadowColor: isDark ? 'transparent' : '#000', shadowOpacity: 0.05, shadowRadius: 6, elevation: 2 }}>
                            <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }}>
                                <Text style={{ fontSize: 18, fontWeight: '700', color: colors.primary }}>üôã ÎÇ¥ Ï†ïÎ≥¥</Text>
                                <TouchableOpacity onPress={handleEditToggle}>
                                    <Text style={{ color: colors.primary,fontSize: 16, fontWeight: '700'}}>‚úèÔ∏è ÏàòÏ†ï</Text>
                                </TouchableOpacity>
                            </View>

                            {[
                                { label: 'Ïù¥Î¶Ñ', value: user.name, key: 'name' },
                                { label: 'Ïù¥Î©îÏùº', value: user.email, key: 'email' },
                                { label: 'Î∂ÄÏÑú', value: user.division, key: 'division' },
                                { label: 'Ï∫†ÌçºÏä§', value: user.campus, key: 'campus' },
                                { label: 'Ïó≠Ìï†', value: user.role, key: 'role' },
                            ].map((item, idx) => (
                                <View key={idx} style={{ marginTop: 8 }}>
                                    <View style={{ flexDirection: 'row' }}>
                                        <Text style={{ fontWeight: '600', color: colors.subtext, width: 70 }}>{item.label}</Text>
                                        {showEditProfile ? (
                                            <TextInput
                                                placeholder={`${item.label} ÏàòÏ†ï`}
                                                value={editValues[item.key] ?? ''}
                                                onChangeText={(text) =>
                                                    setEditValues((prev) => ({ ...prev, [item.key]: text }))
                                                }
                                                style={{
                                                    flex: 1,
                                                    borderWidth: 1,
                                                    borderColor: colors.border,
                                                    borderRadius: 8,
                                                    padding: 8,
                                                    color: colors.text,
                                                }}
                                            />
                                        ) : (
                                            <Text style={{ color: colors.text }}>{item.value}</Text>
                                        )}
                                    </View>
                                </View>
                            ))}

                            {showEditProfile && (
                                <TouchableOpacity
                                    onPress={() => {
                                        setPasswordStage('verify');
                                        setOldPassword('');
                                        setNewPassword('');
                                        setPasswordModalVisible(true);
                                    }}
                                    style={{
                                        backgroundColor: colors.border,
                                        padding: spacing.sm,
                                        borderRadius: radius.md,
                                        alignItems: 'center',
                                        marginTop: spacing.sm,
                                    }}
                                >
                                    <Text style={{ color: colors.text,fontSize: 18,}}>üîí ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</Text>
                                </TouchableOpacity>
                            )}
                            {/* üîê ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Î™®Îã¨ */}
                            <Modal visible={passwordModalVisible} transparent animationType="fade">
                                <View style={{
                                    flex: 1,
                                    backgroundColor: 'rgba(0,0,0,0.4)',
                                    justifyContent: 'center',
                                    alignItems: 'center'
                                }}>
                                    <View style={{
                                        width: '85%',
                                        backgroundColor: colors.surface,
                                        borderRadius: radius.lg,
                                        padding: spacing.lg,
                                    }}>
                                        <Text style={{ fontSize: font.body, fontWeight: '600', marginBottom: spacing.md, color: colors.text }}>
                                            {passwordStage === 'verify' ? 'üîë Í∏∞Ï°¥ ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏' : 'üÜï ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•'}
                                        </Text>

                                        <TextInput
                                            placeholder={passwordStage === 'verify' ? 'Í∏∞Ï°¥ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•' : 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•'}
                                            secureTextEntry
                                            value={passwordStage === 'verify' ? oldPassword : newPassword}
                                            onChangeText={passwordStage === 'verify' ? setOldPassword : setNewPassword}
                                            style={{
                                                borderWidth: 1,
                                                borderColor: colors.border,
                                                borderRadius: 8,
                                                padding: 10,
                                                color: colors.text,
                                                marginBottom: spacing.md,
                                            }}
                                        />

                                        <TouchableOpacity
                                            style={{
                                                backgroundColor: colors.primary,
                                                paddingVertical: spacing.sm,
                                                borderRadius: radius.md,
                                                alignItems: 'center',
                                            }}
                                            onPress={async () => {
                                                try {
                                                    const email = user?.email;
                                                    if (!email) return;

                                                    if (passwordStage === 'verify') {
                                                        await reauthenticate(email, oldPassword);
                                                        setPasswordStage('new');
                                                        setOldPassword('');
                                                    } else {
                                                        await changePassword(newPassword);
                                                        setPasswordModalVisible(false);
                                                        setPasswordStage('verify');
                                                        setNewPassword('');
                                                        Toast.show('‚úÖ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', {
                                                            duration: Toast.durations.SHORT,
                                                            position: Toast.positions.BOTTOM,
                                                        });
                                                    }
                                                } catch (err: any) {
                                                    Alert.alert('Ïò§Î•ò', err.message || 'Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                                                }
                                            }}
                                        >
                                            <Text style={{ color: '#fff', fontWeight: 'bold',fontSize: 20}}>
                                                {passwordStage === 'verify' ? 'ÌôïÏù∏' : 'Ï†ÄÏû•'}
                                            </Text>
                                        </TouchableOpacity>

                                        <TouchableOpacity
                                            onPress={() => {
                                                setPasswordModalVisible(false);
                                                setPasswordStage('verify');
                                                setOldPassword('');
                                                setNewPassword('');
                                            }}
                                            style={{ marginTop: spacing.sm, alignItems: 'center' }}
                                        >
                                            <Text style={{ color: colors.subtext, fontSize: 20}}>Îã´Í∏∞</Text>
                                        </TouchableOpacity>
                                    </View>
                                </View>
                            </Modal>


                            {showEditProfile && (
                                <TouchableOpacity onPress={handleSaveProfile} style={{ backgroundColor: colors.primary, padding: spacing.md, borderRadius: radius.md, alignItems: 'center', marginTop: spacing.md }}>
                                    <Text style={{ color: '#fff', fontWeight: 'bold' }}>üíæ Ï†ÄÏû•</Text>
                                </TouchableOpacity>
                            )}
                        </View>
                    )}


                    <View style={{ backgroundColor: colors.card, paddingVertical: 20, paddingHorizontal: 16, borderRadius: 12, marginVertical: spacing.md, alignSelf: 'stretch', shadowColor: '#000', shadowOffset: { width: 0, height: 2 }, shadowOpacity: 0.1, shadowRadius: 4, elevation: 4, flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between' }}>
                        <Text style={{ fontSize: font.body, fontWeight: '600', color: colors.text }}>üåì Îã§ÌÅ¨Î™®Îìú Ï†ÑÌôò</Text>
                        <ThemeToggle />
                    </View>

                    {/*ÎßêÏîÄ ÏïåÎ¶º*/}
                    <PushSettings />

                    {/*Ïó≠Ìï† Î≥ÄÍ≤Ω*/}
                    {user?.role === 'ÏÉàÍ∞ÄÏ°±' && (
                        <>
                            <TouchableOpacity
                                onPress={() => setShowUpgradeModal(true)}
                                style={{
                                    marginTop: 24,
                                    backgroundColor: colors.primary,
                                    padding: spacing.md,
                                    borderRadius: radius.md,
                                    alignItems: 'center',
                                }}
                            >
                                <Text style={{ color: '#fff', fontWeight: 'bold' }}>üôå Ï†ïÌöåÏõêÏù¥ ÎêòÏóàÎÇòÏöî?</Text>
                            </TouchableOpacity>

                            <Modal visible={showUpgradeModal} transparent animationType="fade">
                                <View style={{
                                    flex: 1,
                                    backgroundColor: 'rgba(0,0,0,0.5)',
                                    justifyContent: 'center',
                                    alignItems: 'center',
                                }}>
                                    <View style={{
                                        backgroundColor: colors.surface,
                                        padding: spacing.lg,
                                        borderRadius: radius.lg,
                                        width: '80%',
                                    }}>
                                        <Text style={{
                                            fontSize: font.body,
                                            fontWeight: '600',
                                            color: colors.text,
                                            marginBottom: spacing.md,
                                        }}>
                                            ÍµêÏó≠ÏûêÎÇò Î™©ÌöåÏûêÏóêÍ≤å ÌôïÏù∏Î∞õÍ≥† Ï†ïÌöåÏõêÏúºÎ°ú Ï†ÑÌôòÌï¥Ï£ºÏÑ∏Ïöî.
                                        </Text>

                                        <TouchableOpacity
                                            onPress={handleUpgrade}
                                            style={{
                                                backgroundColor: colors.primary,
                                                paddingVertical: spacing.md,
                                                borderRadius: radius.md,
                                                alignItems: 'center',
                                                marginBottom: spacing.md,
                                            }}
                                        >
                                            <Text style={{ color: '#fff', fontWeight: 'bold' }}>‚úÖ Ï†ïÌöåÏõê Ï†ÑÌôò</Text>
                                        </TouchableOpacity>

                                        <TouchableOpacity
                                            onPress={() => setShowUpgradeModal(false)}
                                            style={{
                                                alignItems: 'center',
                                                paddingVertical: spacing.sm,
                                            }}
                                        >
                                            <Text style={{ color: colors.subtext }}>Ï∑®ÏÜå</Text>
                                        </TouchableOpacity>
                                    </View>
                                </View>
                            </Modal>
                        </>
                    )}

                    <TouchableOpacity
                        onPress={() => router.push('/setting/feedback')}
                        style={{
                            backgroundColor: colors.surface,
                            borderRadius: radius.md,
                            padding: spacing.md,
                            marginTop: spacing.md,
                            shadowColor: '#000',
                            shadowOffset: { width: 0, height: 2 },
                            shadowOpacity: 0.05,
                            shadowRadius: 6,
                            elevation: 2,
                            alignItems: 'center',
                        }}
                    >
                        <Text style={{ fontSize: font.body, fontWeight: '600', color: colors.text }}>
                            üìù ÌîºÎìúÎ∞± Î≥¥ÎÇ¥Í∏∞
                        </Text>
                    </TouchableOpacity>

                    {user?.role === 'ÍµêÏó≠Ïûê' && (
                        <TouchableOpacity onPress={() => router.push('/setting/videoManager')} style={{ backgroundColor: colors.primary, paddingVertical: spacing.md, borderRadius: radius.md, alignItems: 'center' }}>
                            <Text style={{ color: '#fff', fontSize: font.body, fontWeight: 'bold' }}>üì∫ ÌôàÌôîÎ©¥ Ïú†ÌäúÎ∏å ÏòÅÏÉÅ Í¥ÄÎ¶¨</Text>
                        </TouchableOpacity>
                    )}

                    {/* üîî ÏïåÎ¶º ÏÑ§Ï†ï */}
                    {/*<View style={{
                        backgroundColor: colors.surface,
                        borderRadius: radius.lg,
                        padding: spacing.md,
                        marginVertical: spacing.sm,
                        shadowColor: '#000',
                        shadowOffset: { width: 0, height: 2 },
                        shadowOpacity: 0.05,
                        shadowRadius: 6,
                        elevation: 2,
                    }}>
                        <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }}>
                            <Text style={{ fontSize: font.body, fontWeight: '600', color: colors.text }}>üîî ÏïåÎ¶º ÏÑ§Ï†ï</Text>
                            <TouchableOpacity onPress={() => setNotificationModalVisible(true)}>
                                <Text style={{ color: colors.primary, fontWeight: '600' }}>ÏÑ§Ï†ï</Text>
                            </TouchableOpacity>
                        </View>
                        <NotificationModal
                            visible={notificationModalVisible}
                            onClose={() => setNotificationModalVisible(false)}
                        />
                    </View>*/}

                    {/* üì± Î°úÍ∑∏Ïù∏Îêú Í∏∞Í∏∞ Î≥¥Í∏∞ */}
                    <View style={{
                        backgroundColor: colors.surface,
                        borderRadius: radius.lg,
                        padding: spacing.md,
                        marginVertical: spacing.sm,
                        shadowColor: '#000',
                        shadowOffset: { width: 0, height: 2 },
                        shadowOpacity: 0.05,
                        shadowRadius: 6,
                        elevation: 2,
                    }}>
                        <View style={{ flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center' }}>
                            <Text style={{ fontSize: font.body, fontWeight: '600', color: colors.text }}>üì± Î°úÍ∑∏Ïù∏Îêú Í∏∞Í∏∞ Î≥¥Í∏∞</Text>
                            <TouchableOpacity onPress={() => setModalVisible(true)}>
                                <Text style={{ color: colors.primary, fontWeight: '600' }}>Î™©Î°ù Î≥¥Í∏∞</Text>
                            </TouchableOpacity>
                        </View>
                        <DeviceManager visible={modalVisible} onClose={() => setModalVisible(false)} />
                    </View>

                    {/* ‚ùå Í≥ÑÏ†ï ÌÉàÌá¥ */}
                    <View style={{
                        backgroundColor: colors.surface,
                        borderRadius: radius.lg,
                        padding: spacing.md,
                        marginTop: spacing.md,
                        shadowColor: '#000',
                        shadowOffset: { width: 0, height: 2 },
                        shadowOpacity: 0.05,
                        shadowRadius: 6,
                        elevation: 2,
                    }}>
                        <Text style={{ fontSize: font.body, fontWeight: '600', color: colors.text, marginBottom: spacing.sm }}>
                            ‚ùå Í≥ÑÏ†ï ÌÉàÌá¥
                        </Text>
                        <TouchableOpacity
                            onPress={handleDeleteAccount}
                            style={{
                                backgroundColor: colors.error,
                                paddingVertical: spacing.sm,
                                borderRadius: radius.md,
                                alignItems: 'center',
                            }}
                        >
                            <Text style={{ color: '#fff', fontWeight: 'bold' }}>Í≥ÑÏ†ï ÌÉàÌá¥ÌïòÍ∏∞</Text>
                        </TouchableOpacity>
                    </View>

                    <TouchableOpacity onPress={handleLogout} style={{ backgroundColor: colors.error, paddingVertical: spacing.md, borderRadius: radius.md, alignItems: 'center', marginTop: spacing.lg }}>
                        <Text style={{ color: '#fff', fontSize: font.body, fontWeight: 'bold' }}>Î°úÍ∑∏ÏïÑÏõÉ</Text>
                    </TouchableOpacity>
                </ScrollView>
            </KeyboardAvoidingView>
        </SafeAreaView>
    );
}
